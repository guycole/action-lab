name: action-lab

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
#      deployment:
#        type: choice
#        description: 'deployment environment'
#        options:
#        - development
#        - production
#      environment:
#        type: environment
      release:
        description: 'release version'
        default: '1.0.0'
        required: true

env:
  AWS_REGION: us-west-2
  CLUSTER_NAME: cluster-name
  TAG: ${{ github.run_number }}
 
jobs:
  docker:
    runs-on: ubuntu-latest

    steps:
      - name: repo checkout
        uses: actions/checkout@v3

      - name: ghcr login
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: build and push
        uses: docker/build-push-action@v3
        with:
          context: app
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/guycole/action-lab:latest
            ghcr.io/guycole/action-lab:${{ env.TAG }}

  deploy:
    runs-on: ubuntu-latest
    needs: [docker]

    permissions:
      id-token: write
      contents: read
  
    steps:
      - name: repo checkout
        uses: actions/checkout@v3

      - run: echo "${{ github.event_name }} ${{ github.ref }} $(git branch --show-current)"
        # push
        # refs/heads/main
        # main


#      - name: runner preparation
#        run: |
#          sudo apt update -y 
#          sudo apt install jq awscli -y
#

#      - name: assume oidc role
#        uses: aws-actions/configure-aws-credentials@v1
#        with:
#          aws-region: ${{ env.AWS_REGION }}
#          role-duration-seconds: 1200
#          role-session-name: ${{ github.run_number}}-role
#          role-to-assume: arn:aws:iam::157:role/github_oidc_role
#
#      - name: oidc diagnostic
#        run: aws sts get-caller-identity

#      - name: assume aws eks role
#        uses: aws-actions/configure-aws-credentials@v1
#        with:
#          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
#          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
#          aws-region: ${{ env.AWS_REGION }}
#          role-duration-seconds: 1200
#          role-session-name: ${{ github.run_number}}-role
#          role-to-assume: arn:aws:iam::157:role/github_action_role

# helm install turtle funny-turtle/ --values funny-turtle/values.yaml -n turtle

#      - name: kubeconfing
#        run: aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

#      - name: helm deploy
#        uses: bitovi/github-actions-deploy-eks-helm@v1.1.0
#        with:
#          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#          aws-region: ${{ env.AWS_REGION }}
#          cluster-name: ${{ env.CLUSTER_NAME }}
#          cluster-role-arn: arn:aws:iam::157:role/github_action_role
#          config-files: helm/funny-turtle/values.yaml
#          chart-path: helm/funny-turtle
#          name: turtle
#          namespace: turtle
